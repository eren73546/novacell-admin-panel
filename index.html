<!DOCTYPE html>
<html lang="tr">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NovaCell-3</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<style>
/* --- TEMEL AYARLAR --- */
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg-gradient:linear-gradient(135deg,#667eea,#764ba2);--bg-soft:#f5f7ff;--card-bg:#ffffff;--card-border:rgba(255,255,255,0.6);--card-shadow:0 10px 30px rgba(0,0,0,0.1);--primary:#667eea;--primary-soft:#e0e7ff;--primary-strong:#4c51bf;--danger:#e74c3c;--success:#27ae60;--text-main:#1f2933;--text-soft:#6b7280;--glass-bg:rgba(255,255,255,0.95);--glass-border:1px solid rgba(255,255,255,0.8);--bulk-bg:rgba(255,255,255,0.98)}
body.dark{--bg-gradient:radial-gradient(circle at top,#0f172a,#020617);--bg-soft:#020617;--card-bg:rgba(30,41,59,0.95);--card-border:1px solid rgba(148,163,184,0.15);--card-shadow:0 10px 30px rgba(0,0,0,0.5);--primary:#818cf8;--primary-soft:rgba(129,140,248,0.15);--primary-strong:#4c51bf;--danger:#fb7185;--success:#4ade80;--text-main:#e2e8f0;--text-soft:#94a3b8;--glass-bg:rgba(15,23,42,0.95);--glass-border:1px solid rgba(148,163,184,0.2);--bulk-bg:rgba(30,41,59,0.98)}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:var(--bg-gradient);min-height:100vh;color:var(--text-main);font-size:14px;line-height:1.5;padding-bottom:40px}

/* --- GÄ°RÄ°Å EKRANI --- */
.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
.login-box{background:var(--glass-bg);padding:30px;border-radius:20px;box-shadow:var(--card-shadow);border:var(--glass-border);backdrop-filter:blur(10px);width:100%;max-width:400px}
.login-box h2{text-align:center;color:var(--primary);margin-bottom:10px;font-size:24px}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-weight:600}
.form-group input{width:100%;padding:12px;border:1px solid rgba(0,0,0,0.1);border-radius:10px;background:rgba(255,255,255,0.8);font-size:16px} /* Mobil iÃ§in font 16px */
.btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--primary),var(--primary-strong));color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;margin-top:10px}

/* --- PANEL DÃœZENÄ° --- */
.dashboard{display:none}
.dashboard.active{display:block}
.header{position:sticky;top:0;z-index:100;background:var(--glass-bg);backdrop-filter:blur(12px);border-bottom:var(--glass-border);padding:10px 15px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.header h1{font-size:18px;font-weight:800;color:var(--text-main)}
.header-actions{display:flex;gap:8px;align-items:center}
.container{max-width:1400px;margin:15px auto;padding:0 15px}

/* --- MOBÄ°L UYUMLU BUTONLAR --- */
button{cursor:pointer;touch-action:manipulation} /* Dokunmatik gecikmesini Ã¶nler */
.btn-logout,.btn-refresh,.export-btn,.btn-theme{padding:8px 12px;font-size:13px;border-radius:8px;border:none;color:#fff;font-weight:600}
.btn-logout{background:var(--danger)}
.btn-refresh{background:var(--success)}
.export-btn{background:var(--primary)}
.btn-theme{background:#333;padding:8px}

/* --- Ä°STATÄ°STÄ°K KARTLARI (Responsive Grid) --- */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:20px}
.stat-card{background:var(--card-bg);padding:15px;border-radius:15px;border:var(--card-border);box-shadow:var(--card-shadow);text-align:center}
.stat-card h3{font-size:11px;color:var(--text-soft);text-transform:uppercase;margin-bottom:5px}
.stat-card .value{font-size:20px;font-weight:800;color:var(--primary)}

/* --- TABLO ALANI --- */
.users-section{background:var(--card-bg);padding:15px;border-radius:15px;box-shadow:var(--card-shadow);overflow:hidden}
.search-bulk-row{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
#searchInput{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);min-width:200px}

/* MasaÃ¼stÃ¼ Tablo GÃ¶rÃ¼nÃ¼mÃ¼ */
.users-table-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch} /* Mobilde yumuÅŸak kaydÄ±rma */
table{width:100%;border-collapse:collapse;min-width:1000px} /* Tablo en az 1000px olsun ki mobilde kaydÄ±rÄ±labilsin */
th{text-align:left;padding:12px 8px;font-size:12px;color:var(--text-soft);border-bottom:1px solid rgba(0,0,0,0.1)}
td{padding:12px 8px;border-bottom:1px solid rgba(0,0,0,0.05);font-size:13px}

/* --- MOBÄ°L KART GÃ–RÃœNÃœMÃœ (Ekran 768px altÄ±ndaysa tabloyu gizle, kartlarÄ± gÃ¶ster) --- */
#usersCardsContainer{display:none} /* VarsayÄ±lan gizli */

@media (max-width: 768px) {
  .users-table-wrapper { display: none !important; } /* Tabloyu gizle */
  #usersCardsContainer { display: grid; gap: 10px; grid-template-columns: 1fr; } /* KartlarÄ± gÃ¶ster */
  
  .user-card {
    background: var(--card-bg);
    border: var(--card-border);
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .card-header { display: flex; justify-content: space-between; align-items: center; }
  .card-user { font-weight: bold; font-size: 15px; color: var(--primary); }
  .card-status { font-size: 11px; padding: 3px 8px; border-radius: 20px; font-weight: bold; }
  .card-row { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-soft); }
  .card-actions { display: flex; gap: 5px; margin-top: 10px; }
  .card-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; color: #fff; font-weight: 600; font-size: 13px; }
}

/* --- DÄ°ÄER BÄ°LEÅENLER --- */
.badge{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:700}
.badge-active{background:#dcfce7;color:#166534}
.badge-passive{background:#fee2e2;color:#991b1b}
.progress-bar{height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden;width:100px}
.progress-fill{height:100%;background:var(--primary)}

/* Toggle Switch */
.toggle-switch{position:relative;width:44px;height:24px;display:inline-block}
.toggle-switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}
.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%}
input:checked+.slider{background-color:var(--success)}
input:checked+.slider:before{transform:translateX(20px)}

/* Modals */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;padding:15px}
.modal.active{display:flex}
.modal-content{background:var(--card-bg);width:100%;max-width:500px;border-radius:15px;padding:20px;max-height:90vh;overflow-y:auto}
.modal-actions{display:flex;gap:10px;margin-top:20px}
.modal-btn{flex:1;padding:12px;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
.modal-btn-primary{background:var(--primary);color:#fff}
.modal-btn-secondary{background:#e2e8f0;color:#333}

/* Bildirim Paneli */
.notification-panel{position:fixed;top:60px;right:10px;width:300px;max-width:90vw;background:var(--card-bg);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);display:none;z-index:900}
.notification-panel.active{display:block}
.notification-item{padding:12px;border-bottom:1px solid rgba(0,0,0,0.05);font-size:13px}

/* Loader */
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;display:none;justify-content:center;align-items:center}
.loading-overlay.active{display:flex}
.spinner{width:40px;height:40px;border:4px solid #fff;border-top-color:var(--primary);border-radius:50%;animation:spin 1s infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

<div class="login-container" id="loginPage">
  <div class="login-box">
    <h2>ğŸ” NovaCell-3</h2>
    <p style="text-align:center;color:var(--text-soft);margin-bottom:20px">YÃ¶netim Paneli</p>
    <form id="loginForm">
      <div class="form-group">
        <label>KullanÄ±cÄ± AdÄ±</label>
        <input type="text" id="username" required>
      </div>
      <div class="form-group">
        <label>Åifre</label>
        <input type="password" id="password" required>
      </div>
      <button type="submit" class="btn">GiriÅŸ Yap</button>
      <div id="loginError" style="color:var(--danger);text-align:center;margin-top:10px"></div>
    </form>
  </div>
</div>

<div class="dashboard" id="dashboardPage">
  <div class="header">
    <div>
      <h1>NovaCell-3</h1>
      <div id="liveClock" style="font-size:11px;color:var(--text-soft)">YÃ¼kleniyor...</div>
    </div>
    <div class="header-actions">
      <button class="btn-theme" onclick="toggleTheme()" id="themeToggleBtn">ğŸŒ™</button>
      <div style="position:relative;cursor:pointer" onclick="toggleNotifications()">
        ğŸ”” <span id="notificationBadge" style="background:red;color:white;border-radius:50%;padding:2px 6px;font-size:10px;position:absolute;top:-5px;right:-5px">0</span>
      </div>
      <button class="btn-refresh" onclick="refreshData()">ğŸ”„</button>
      <button class="btn-logout" onclick="logout()">ğŸšª</button>
    </div>
    <div class="notification-panel" id="notificationPanel"></div>
  </div>

  <div class="container">
    <div class="stats-grid">
      <div class="stat-card"><h3>Toplam</h3><div class="value" id="totalUsers">0</div></div>
      <div class="stat-card"><h3>Aktif</h3><div class="value" id="activeUsers">0</div></div>
      <div class="stat-card"><h3>Pasif</h3><div class="value" id="passiveUsers">0</div></div>
      <div class="stat-card"><h3>Online</h3><div class="value" id="onlineUsers">0</div></div>
      <div class="stat-card"><h3>KullanÄ±m</h3><div class="value" id="totalUsage">0 GB</div></div>
    </div>

    <div class="users-section">
      <div class="search-bulk-row">
        <input type="text" id="searchInput" placeholder="ğŸ” Ara..." onkeyup="filterUsers()">
        <select id="folderFilter" onchange="filterByFolder(this.value)" style="padding:12px;border-radius:10px;border:1px solid #ddd">
          <option value="TÃ¼mÃ¼">ğŸ“ TÃ¼mÃ¼</option>
          <option value="Superbox">ğŸ“¡ Superbox</option>
          <option value="AX">ğŸ“¶ AX</option>
          <option value="GSM">ğŸ“± GSM</option>
          <option value="Ã–ZEL">ğŸ”’ Ã–zel</option>
        </select>
      </div>

      <div class="users-table-wrapper">
        <table>
          <thead>
            <tr>
              <th>KullanÄ±cÄ±</th>
              <th>Not</th>
              <th>Paket</th>
              <th>KullanÄ±m</th>
              <th>Durum</th>
              <th>Online</th>
              <th>Ã–deme</th>
              <th>Ä°ÅŸlem</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      </div>

      <div id="usersCardsContainer"></div>
    </div>
  </div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h3>âš™ï¸ Ayarlar: <span id="settingsUserName"></span></h3>
    <div class="form-group">
      <label>Kota (GB) (0=SÄ±nÄ±rsÄ±z)</label>
      <input type="number" id="settingsQuota">
    </div>
    <div class="form-group">
      <label>Son Kullanma</label>
      <input type="date" id="settingsExpiryDate">
    </div>
    <div class="form-group">
      <label>Fiyat</label>
      <input type="number" id="settingsPrice">
    </div>
    <div class="form-group">
      <label>Not</label>
      <textarea id="settingsNotes" style="width:100%;border:1px solid #ddd;border-radius:8px;padding:10px"></textarea>
    </div>
    <div class="form-group">
      <label>KlasÃ¶r</label>
      <select id="settingsFolder" style="width:100%;padding:10px;border-radius:8px">
        <option value="TÃ¼mÃ¼">TÃ¼mÃ¼</option>
        <option value="Superbox">Superbox</option>
        <option value="AX">AX</option>
        <option value="GSM">GSM</option>
        <option value="Ã–ZEL">Ã–zel</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-primary" onclick="saveSettings()">Kaydet</button>
      <button class="modal-btn modal-btn-secondary" onclick="closeSettingsModal()">Ä°ptal</button>
    </div>
  </div>
</div>

<div class="modal" id="paymentModal">
  <div class="modal-content">
    <h3>ğŸ’° Ã–deme Al: <span id="paymentUserName"></span></h3>
    <div class="form-group"><label>Tutar</label><input type="number" id="paymentAmount"></div>
    <div class="form-group"><label>Tarih</label><input type="date" id="paymentDate"></div>
    <div class="form-group"><label>Not</label><input type="text" id="paymentNote"></div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-primary" onclick="savePayment()">Ã–deme Al</button>
      <button class="modal-btn modal-btn-secondary" onclick="closePaymentModal()">Ä°ptal</button>
    </div>
  </div>
</div>

<script>
let allUsers = [];
let currentSettingsEmail = '';
let currentPaymentEmail = '';

// --- TEMA VE GÄ°RÄ°Å ---
function initTheme() {
  const isDark = localStorage.getItem('nc-theme') === 'dark';
  document.body.classList.toggle('dark', isDark);
  document.getElementById('themeToggleBtn').textContent = isDark ? 'ğŸŒ' : 'ğŸŒ™';
}
function toggleTheme() {
  const isDark = document.body.classList.toggle('dark');
  localStorage.setItem('nc-theme', isDark ? 'dark' : 'light');
  initTheme();
}
window.addEventListener('DOMContentLoaded', () => { initTheme(); checkAuth(); });

async function checkAuth() {
  try {
    const r = await fetch('/api/check-auth');
    const d = await r.json();
    if (d.authenticated) { showDashboard(); loadData(); } else { showLogin(); }
  } catch { showLogin(); }
}

document.getElementById('loginForm').addEventListener('submit', async e => {
  e.preventDefault();
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  const r = await fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: u, password: p })
  });
  const d = await r.json();
  if (d.success) { showDashboard(); loadData(); } else { document.getElementById('loginError').textContent = 'HatalÄ± giriÅŸ'; }
});

function showLogin() { document.getElementById('loginPage').style.display = 'flex'; document.getElementById('dashboardPage').classList.remove('active'); }
function showDashboard() { document.getElementById('loginPage').style.display = 'none'; document.getElementById('dashboardPage').classList.add('active'); startClock(); }
async function logout() { await fetch('/api/logout', { method: 'POST' }); showLogin(); }

function startClock() {
  setInterval(() => {
    const now = new Date();
    document.getElementById('liveClock').textContent = now.toLocaleDateString('tr-TR') + ' ' + now.toLocaleTimeString('tr-TR');
  }, 1000);
}

// --- VERÄ° YÃœKLEME ---
async function loadData() {
  const [statsRes, usersRes, notifRes] = await Promise.all([
    fetch('/api/stats'),
    fetch('/api/users'),
    fetch('/api/notifications')
  ]);
  
  if (statsRes.ok) {
    const stats = await statsRes.json();
    document.getElementById('totalUsers').textContent = stats.total_users;
    document.getElementById('activeUsers').textContent = stats.active_users;
    document.getElementById('passiveUsers').textContent = stats.total_users - stats.active_users;
    document.getElementById('onlineUsers').textContent = stats.online_users || 0;
    document.getElementById('totalUsage').textContent = stats.total_usage_gb + ' GB';
  }
  
  if (usersRes.ok) {
    allUsers = await usersRes.json();
    renderUsers(allUsers);
  }

  if (notifRes.ok) {
    const notifs = await notifRes.json();
    document.getElementById('notificationBadge').textContent = notifs.length;
    const panel = document.getElementById('notificationPanel');
    panel.innerHTML = notifs.length ? notifs.map(n => `<div class="notification-item"><strong>${n.user}</strong>: ${n.message}</div>`).join('') : '<div style="padding:10px">Bildirim yok</div>';
  }
}

function renderUsers(users) {
  const tbody = document.getElementById('usersTableBody');
  const cards = document.getElementById('usersCardsContainer');
  tbody.innerHTML = '';
  cards.innerHTML = '';

  if (!users.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px">KullanÄ±cÄ± yok</td></tr>';
    cards.innerHTML = '<div style="text-align:center;padding:20px">KullanÄ±cÄ± yok</div>';
    return;
  }

  users.forEach(u => {
    const isActive = u.durum === 'aktif';
    const statusClass = isActive ? 'badge-active' : 'badge-passive';
    const quotaPercent = u.kota_limit_gb !== "SÄ±nÄ±rsÄ±z" ? Math.min((u.kullanilan_kota_gb / u.kota_limit_gb) * 100, 100) : 0;
    
    // MasaÃ¼stÃ¼ SatÄ±rÄ±
    const tr = `
      <tr>
        <td><strong>${u.kullanici_adi}</strong><br><small style="color:#888">${u.folder}</small></td>
        <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${u.notes || '-'}</td>
        <td><span class="badge" style="background:#eee">${u.paket_tipi}</span></td>
        <td>
          <div style="font-size:11px">${u.kullanilan_kota_gb} / ${u.kota_limit_gb} GB</div>
          ${u.kota_limit_gb !== "SÄ±nÄ±rsÄ±z" ? `<div class="progress-bar"><div class="progress-fill" style="width:${quotaPercent}%"></div></div>` : ''}
        </td>
        <td><span class="badge ${statusClass}">${u.durum.toUpperCase()}</span></td>
        <td>${u.online_status === 'online' ? 'ğŸŸ¢' : 'âšª'}</td>
        <td>${u.days_until_payment !== null ? u.days_until_payment + 'g' : '-'}</td>
        <td>
          <div style="display:flex;gap:5px;align-items:center">
            <label class="toggle-switch">
              <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleUser('${u.email}', this.checked)">
              <span class="slider"></span>
            </label>
            <button class="btn-theme" style="background:#3b82f6;color:white;padding:5px 8px" onclick="openSettings('${u.email}')">âš™ï¸</button>
            <button class="btn-theme" style="background:#10b981;color:white;padding:5px 8px" onclick="openPayment('${u.email}')">ğŸ’°</button>
          </div>
        </td>
      </tr>
    `;
    tbody.innerHTML += tr;

    // Mobil Kart
    const card = `
      <div class="user-card">
        <div class="card-header">
          <div class="card-user">${u.kullanici_adi}</div>
          <div class="card-status" style="background:${isActive?'#dcfce7':'#fee2e2'};color:${isActive?'#166534':'#991b1b'}">${u.durum.toUpperCase()}</div>
        </div>
        <div class="card-row"><span>Paket:</span> <span>${u.paket_tipi}</span></div>
        <div class="card-row"><span>Kota:</span> <span>${u.kullanilan_kota_gb} / ${u.kota_limit_gb} GB</span></div>
        ${u.kota_limit_gb !== "SÄ±nÄ±rsÄ±z" ? `<div class="progress-bar" style="width:100%"><div class="progress-fill" style="width:${quotaPercent}%"></div></div>` : ''}
        <div class="card-row"><span>Ã–deme:</span> <span>${u.days_until_payment !== null ? u.days_until_payment + ' gÃ¼n kaldÄ±' : '-'}</span></div>
        <div class="card-actions">
          <button class="card-btn" style="background:#3b82f6" onclick="openSettings('${u.email}')">Ayarlar</button>
          <button class="card-btn" style="background:#10b981" onclick="openPayment('${u.email}')">Ã–deme</button>
          <button class="card-btn" style="background:${isActive?'#ef4444':'#22c55e'}" onclick="toggleUser('${u.email}', ${!isActive})">${isActive ? 'Kapat' : 'AÃ§'}</button>
        </div>
      </div>
    `;
    cards.innerHTML += card;
  });
}

function filterUsers() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const folder = document.getElementById('folderFilter').value;
  const filtered = allUsers.filter(u => {
    const matchSearch = u.kullanici_adi.toLowerCase().includes(search) || (u.notes && u.notes.toLowerCase().includes(search));
    const matchFolder = folder === 'TÃ¼mÃ¼' || u.folder === folder;
    return matchSearch && matchFolder;
  });
  renderUsers(filtered);
}

function filterByFolder(val) { filterUsers(); }

async function toggleUser(email, enable) {
  document.getElementById('loadingOverlay').classList.add('active');
  try {
    await fetch('/api/toggle-user', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, enable })
    });
    await loadData();
  } catch { alert('Hata!'); }
  document.getElementById('loadingOverlay').classList.remove('active');
}

function openSettings(email) {
  const user = allUsers.find(u => u.email === email);
  if (!user) return;
  currentSettingsEmail = email;
  document.getElementById('settingsUserName').textContent = email;
  document.getElementById('settingsQuota').value = user.kota_limit_gb === "SÄ±nÄ±rsÄ±z" ? 0 : parseFloat(user.kota_limit_gb);
  document.getElementById('settingsExpiryDate').value = user.expiry_date_only || '';
  document.getElementById('settingsPrice').value = user.monthly_price || 0;
  document.getElementById('settingsNotes').value = user.notes || '';
  document.getElementById('settingsFolder').value = user.folder || 'TÃ¼mÃ¼';
  document.getElementById('settingsModal').classList.add('active');
}

function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('active'); }

async function saveSettings() {
  const data = {
    email: currentSettingsEmail,
    quota: document.getElementById('settingsQuota').value,
    expiry_date: document.getElementById('settingsExpiryDate').value,
    monthly_price: document.getElementById('settingsPrice').value,
    notes: document.getElementById('settingsNotes').value,
    folder: document.getElementById('settingsFolder').value
  };
  
  document.getElementById('loadingOverlay').classList.add('active');
  try {
    await fetch('/api/update-user-settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    closeSettingsModal();
    await loadData();
  } catch { alert('Hata'); }
  document.getElementById('loadingOverlay').classList.remove('active');
}

function openPayment(email) {
  currentPaymentEmail = email;
  document.getElementById('paymentUserName').textContent = email;
  document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('paymentModal').classList.add('active');
}

function closePaymentModal() { document.getElementById('paymentModal').classList.remove('active'); }

async function savePayment() {
  const data = {
    email: currentPaymentEmail,
    amount: document.getElementById('paymentAmount').value,
    payment_date: document.getElementById('paymentDate').value,
    notes: document.getElementById('paymentNote').value
  };
  document.getElementById('loadingOverlay').classList.add('active');
  try {
    await fetch('/api/add-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    closePaymentModal();
    await loadData();
  } catch { alert('Hata'); }
  document.getElementById('loadingOverlay').classList.remove('active');
}

function toggleNotifications() {
  document.getElementById('notificationPanel').classList.toggle('active');
}

function refreshData() {
  document.getElementById('loadingOverlay').classList.add('active');
  loadData().then(() => document.getElementById('loadingOverlay').classList.remove('active'));
}

// 30 Saniyede bir otomatik yenile
setInterval(() => {
  if (document.getElementById('dashboardPage').classList.contains('active')) loadData();
}, 30000);
</script>
</body>
</html>
